name: Update README

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:
  push:
    paths:
      - 'now.json'  # Trigger when Now section is updated

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Generate activity + now sections
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let readme = fs.readFileSync('README.md', 'utf8');
            let updated = false;

            // --- RECENT ACTIVITY ---
            const events = await github.rest.activity.listPublicEventsForUser({
              username: 'curtismercier',
              per_page: 100
            });

            const icons = {
              PushEvent: 'âš¡',
              PullRequestEvent: 'ðŸ”€',
              CreateEvent: 'ðŸ“¦',
              IssuesEvent: 'ðŸ›',
              IssueCommentEvent: 'ðŸ’¬',
              WatchEvent: 'â­',
              ForkEvent: 'ðŸ´',
              ReleaseEvent: 'ðŸš€'
            };

            const seen = new Set();
            const activity = [];

            for (const event of events.data) {
              if (activity.length >= 5) break;

              const repo = event.repo.name;
              const icon = icons[event.type] || 'ðŸ“Œ';
              let line = '';

              switch (event.type) {
                case 'PushEvent': {
                  const count = event.payload.commits?.length || 0;
                  if (count === 0) continue;
                  const branch = (event.payload.ref || '').replace('refs/heads/', '');
                  const key = `push-${repo}-${branch}`;
                  if (seen.has(key)) continue;
                  seen.add(key);
                  line = `${icon} Pushed ${count} commit${count !== 1 ? 's' : ''} to \`${repo}\``;
                  if (branch && branch !== 'main' && branch !== 'master') {
                    line += ` on \`${branch}\``;
                  }
                  break;
                }
                case 'PullRequestEvent': {
                  const pr = event.payload.pull_request || {};
                  const action = event.payload.action;
                  if (action !== 'opened' && action !== 'closed') continue;
                  const prNum = pr.number || event.payload.number;
                  const key = `pr-${repo}-${prNum}`;
                  if (seen.has(key)) continue;
                  seen.add(key);
                  const merged = pr.merged ? 'Merged' : action === 'closed' ? 'Closed' : 'Opened';
                  const prIcon = pr.merged ? 'ðŸŸ£' : action === 'opened' ? 'ðŸ”€' : 'âŒ';
                  const prUrl = pr.html_url || `https://github.com/${repo}/pull/${prNum}`;
                  const prTitle = pr.title || '';
                  line = `${prIcon} ${merged} PR [#${prNum}](${prUrl}) on \`${repo}\``;
                  if (prTitle) line += ` â€” ${prTitle}`;
                  break;
                }
                case 'CreateEvent': {
                  if (event.payload.ref_type === 'repository') {
                    const key = `create-${repo}`;
                    if (seen.has(key)) continue;
                    seen.add(key);
                    line = `${icon} Created [\`${repo}\`](https://github.com/${repo})`;
                  } else if (event.payload.ref_type === 'branch') {
                    const key = `branch-${repo}-${event.payload.ref}`;
                    if (seen.has(key)) continue;
                    seen.add(key);
                    line = `ðŸŒ¿ Created branch \`${event.payload.ref}\` on \`${repo}\``;
                  } else continue;
                  break;
                }
                case 'IssueCommentEvent': {
                  const issue = event.payload.issue;
                  const key = `comment-${repo}-${issue.number}`;
                  if (seen.has(key)) continue;
                  seen.add(key);
                  line = `${icon} Commented on [#${issue.number}](${issue.html_url}) in \`${repo}\``;
                  break;
                }
                default:
                  continue;
              }

              if (line) activity.push(line);
            }

            const activityBlock = activity.length > 0
              ? activity.join('\n\n')
              : '*Quiet week. Building in the dark.*';

            const actStart = '<!-- ACTIVITY:START -->';
            const actEnd = '<!-- ACTIVITY:END -->';
            if (readme.includes(actStart)) {
              const re = new RegExp(`${actStart}[\\s\\S]*?${actEnd}`, 'g');
              readme = readme.replace(re, `${actStart}\n${activityBlock}\n${actEnd}`);
              updated = true;
            }

            // --- NOW SECTION ---
            try {
              const nowData = JSON.parse(fs.readFileSync('now.json', 'utf8'));
              const nowLines = nowData.map(item => `${item.icon} ${item.text}`).join('<br/>\n');
              const nowStart = '<!-- NOW:START -->';
              const nowEnd = '<!-- NOW:END -->';
              if (readme.includes(nowStart)) {
                const re = new RegExp(`${nowStart}[\\s\\S]*?${nowEnd}`, 'g');
                readme = readme.replace(re, `${nowStart}\n${nowLines}\n${nowEnd}`);
                updated = true;
              }
            } catch (e) {
              console.log('now.json not found or invalid, skipping Now section');
            }

            if (updated) {
              fs.writeFileSync('README.md', readme);
            }

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet README.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config --local user.email "curtismercier@users.noreply.github.com"
          git config --local user.name "Curtis Mercier"
          git add README.md
          git commit -m "chore: update activity feed + now section"
          git push
