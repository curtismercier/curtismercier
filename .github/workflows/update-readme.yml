name: Update README

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:
  push:
    paths:
      - 'now.json'  # Trigger when Now section is updated

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Generate activity + now sections
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let readme = fs.readFileSync('README.md', 'utf8');
            let updated = false;

            // --- RECENT ACTIVITY (two tiers) ---
            const events = await github.rest.activity.listPublicEventsForUser({
              username: 'curtismercier',
              per_page: 100
            });

            const seen = new Set();
            const highlights = [];  // PRs, releases, repo creation
            const other = [];       // Comments, pushes, branches, stars, forks

            for (const event of events.data) {
              if (highlights.length >= 5 && other.length >= 5) break;

              const repo = event.repo.name;
              let line = '';
              let isHighlight = false;

              switch (event.type) {
                case 'PullRequestEvent': {
                  const pr = event.payload.pull_request || {};
                  const action = event.payload.action;
                  if (action !== 'opened' && action !== 'closed') continue;
                  const prNum = pr.number || event.payload.number;
                  const key = `pr-${repo}-${prNum}`;
                  if (seen.has(key)) continue;
                  seen.add(key);
                  const merged = pr.merged ? 'Merged' : action === 'closed' ? 'Closed' : 'Opened';
                  const prIcon = pr.merged ? 'ðŸŸ£' : action === 'opened' ? 'ðŸ”€' : 'âŒ';
                  const prUrl = pr.html_url || `https://github.com/${repo}/pull/${prNum}`;
                  const prTitle = pr.title || '';

                  // Fetch detailed PR stats + title
                  let statsStr = '';
                  let detailTitle = prTitle;
                  try {
                    const [owner, repoName] = repo.split('/');
                    const detail = await github.rest.pulls.get({ owner, repo: repoName, pull_number: prNum });
                    const adds = detail.data.additions || 0;
                    const dels = detail.data.deletions || 0;
                    const files = detail.data.changed_files || 0;
                    statsStr = ` \`+${adds} -${dels}\` across ${files} file${files !== 1 ? 's' : ''}`;
                    if (!detailTitle) detailTitle = detail.data.title || '';
                  } catch (e) { /* stats unavailable */ }

                  line = `${prIcon} ${merged} PR [#${prNum}](${prUrl}) on \`${repo}\``;
                  if (detailTitle) line += ` â€” **${detailTitle}**`;
                  if (statsStr) line += statsStr;
                  // Only opened and merged PRs are highlights; closed (not merged) goes to other
                  isHighlight = action === 'opened' || pr.merged;
                  break;
                }
                case 'ReleaseEvent': {
                  const release = event.payload.release || {};
                  const key = `release-${repo}-${release.tag_name}`;
                  if (seen.has(key)) continue;
                  seen.add(key);
                  const relUrl = release.html_url || `https://github.com/${repo}/releases`;
                  line = `ðŸš€ Released [${release.tag_name || 'new version'}](${relUrl}) on \`${repo}\``;
                  isHighlight = true;
                  break;
                }
                case 'CreateEvent': {
                  if (event.payload.ref_type === 'repository') {
                    const key = `create-${repo}`;
                    if (seen.has(key)) continue;
                    seen.add(key);
                    line = `ðŸ“¦ Created [\`${repo}\`](https://github.com/${repo})`;
                    isHighlight = true;
                  } else if (event.payload.ref_type === 'branch') {
                    const branch = event.payload.ref || '';
                    // Skip default branches â€” only feature branches are interesting
                    if (branch === 'main' || branch === 'master') continue;
                    const key = `branch-${repo}-${branch}`;
                    if (seen.has(key)) continue;
                    seen.add(key);
                    line = `ðŸŒ¿ Created branch \`${branch}\` on \`${repo}\``;
                    isHighlight = true;
                  } else continue;
                  break;
                }
                case 'PushEvent': {
                  const count = event.payload.commits?.length || 0;
                  if (count === 0) continue;
                  const branch = (event.payload.ref || '').replace('refs/heads/', '');
                  const key = `push-${repo}-${branch}`;
                  if (seen.has(key)) continue;
                  seen.add(key);
                  line = `âš¡ Pushed ${count} commit${count !== 1 ? 's' : ''} to \`${repo}\``;
                  if (branch && branch !== 'main' && branch !== 'master') {
                    line += ` on \`${branch}\``;
                  }
                  break;
                }
                case 'IssueCommentEvent': {
                  const issue = event.payload.issue;
                  const key = `comment-${repo}-${issue.number}`;
                  if (seen.has(key)) continue;
                  seen.add(key);
                  line = `ðŸ’¬ Commented on [#${issue.number}](${issue.html_url}) in \`${repo}\``;
                  break;
                }
                case 'WatchEvent': {
                  const key = `star-${repo}`;
                  if (seen.has(key)) continue;
                  seen.add(key);
                  line = `â­ Starred [\`${repo}\`](https://github.com/${repo})`;
                  break;
                }
                case 'ForkEvent': {
                  const key = `fork-${repo}`;
                  if (seen.has(key)) continue;
                  seen.add(key);
                  line = `ðŸ´ Forked [\`${repo}\`](https://github.com/${repo})`;
                  break;
                }
                default:
                  continue;
              }

              if (!line) continue;

              // Priority for sorting within "other": closed PRs > pushes > branches > comments > stars/forks
              const priorityMap = { PullRequestEvent: 1, PushEvent: 2, CreateEvent: 3, IssueCommentEvent: 4, WatchEvent: 5, ForkEvent: 5 };
              const priority = priorityMap[event.type] || 5;

              if (isHighlight && highlights.length < 5) {
                highlights.push(line);
              } else if (!isHighlight && other.length < 8) {
                other.push({ line, priority });
              }
            }

            // Sort other by priority (most important first)
            other.sort((a, b) => a.priority - b.priority);
            const otherLines = other.map(o => o.line);

            // Build highlights block
            const highlightsBlock = highlights.length > 0
              ? highlights.join('\n\n')
              : '*No major activity yet. Building in the dark.*';

            const hlStart = '<!-- HIGHLIGHTS:START -->';
            const hlEnd = '<!-- HIGHLIGHTS:END -->';
            if (readme.includes(hlStart)) {
              const re = new RegExp(`${hlStart}[\\s\\S]*?${hlEnd}`, 'g');
              readme = readme.replace(re, `${hlStart}\n${highlightsBlock}\n${hlEnd}`);
              updated = true;
            }

            // Build other activity block
            const otherBlock = otherLines.length > 0
              ? otherLines.join('\n\n')
              : '*Quiet week.*';

            const otStart = '<!-- OTHER:START -->';
            const otEnd = '<!-- OTHER:END -->';
            if (readme.includes(otStart)) {
              const re = new RegExp(`${otStart}[\\s\\S]*?${otEnd}`, 'g');
              readme = readme.replace(re, `${otStart}\n${otherBlock}\n${otEnd}`);
              updated = true;
            }

            // --- NOW SECTION ---
            try {
              const nowData = JSON.parse(fs.readFileSync('now.json', 'utf8'));
              const nowLines = nowData.map(item => `${item.icon} ${item.text}`).join('<br/>\n');
              const nowStart = '<!-- NOW:START -->';
              const nowEnd = '<!-- NOW:END -->';
              if (readme.includes(nowStart)) {
                const re = new RegExp(`${nowStart}[\\s\\S]*?${nowEnd}`, 'g');
                readme = readme.replace(re, `${nowStart}\n${nowLines}\n${nowEnd}`);
                updated = true;
              }
            } catch (e) {
              console.log('now.json not found or invalid, skipping Now section');
            }

            if (updated) {
              fs.writeFileSync('README.md', readme);
            }

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet README.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config --local user.email "curtismercier@users.noreply.github.com"
          git config --local user.name "Curtis Mercier"
          git add README.md
          git commit -m "chore: update activity feed + now section"
          git push
